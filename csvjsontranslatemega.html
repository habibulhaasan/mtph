<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega CSV Tool - Gemini AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Bangla Font */
        .bn-font {
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        /* Code Font for exports */
        .code-font {
            font-family: 'Fira Code', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }

        /* Smooth table animations */
        tr {
            transition: background-color 0.15s ease;
        }

        /* Column Tag Animation */
        .col-tag {
            transition: all 0.2s;
        }
        .col-tag:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4 text-slate-800">

    <div class="max-w-[95%] w-full bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col h-[92vh]">
        
        <!-- Header -->
        <div class="bg-slate-900 text-white p-5 flex justify-between items-center shrink-0 shadow-md z-20">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-500/30">
                        <i class="fa-solid fa-robot text-white"></i>
                    </div>
                    <span>Mega CSV Tool <span class="text-xs bg-indigo-500 px-2 py-0.5 rounded-full ml-2">AI Powered</span></span>
                </h1>
                <p class="text-slate-400 text-xs mt-1 ml-1">Translate • Normalize • Export Code</p>
            </div>
            
            <div class="flex gap-3 items-center">
                 <button onclick="resetApp()" class="px-3 py-2 text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition-colors text-sm font-medium mr-2">
                    <i class="fa-solid fa-folder-open mr-2"></i> New
                </button>
                
                <!-- Format Selector -->
                <div class="mr-3">
                    <select id="exportFormat" class="text-xs bg-slate-800 text-slate-300 border border-slate-600 rounded px-2 py-1 outline-none focus:border-indigo-500 cursor-pointer hover:text-white transition-colors" title="Select export formatting style">
                        <option value="pretty">Pretty Print (Standard)</option>
                        <option value="lines">One Record Per Line</option>
                        <option value="single">Single Line (Minified)</option>
                    </select>
                </div>

                <!-- Export Dropdown Logic -->
                <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                    <button onclick="downloadCSV()" id="btnExpCsv" disabled class="px-3 py-1.5 text-xs font-semibold rounded hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-green-400">
                        CSV
                    </button>
                    <div class="w-[1px] bg-slate-700 my-1"></div>
                    <button onclick="downloadJSON()" id="btnExpJson" disabled class="px-3 py-1.5 text-xs font-semibold rounded hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-yellow-400">
                        JSON
                    </button>
                    <div class="w-[1px] bg-slate-700 my-1"></div>
                    <button onclick="downloadJS()" id="btnExpJs" disabled class="px-3 py-1.5 text-xs font-semibold rounded hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-blue-400">
                        JS
                    </button>
                    <div class="w-[1px] bg-slate-700 my-1"></div>
                    <button onclick="downloadPython()" id="btnExpPy" disabled class="px-3 py-1.5 text-xs font-semibold rounded hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-purple-400">
                        Python
                    </button>
                </div>
            </div>
        </div>

        <!-- Toolbar (Only visible after upload) -->
        <div id="toolbar" class="bg-white border-b border-slate-200 p-4 flex flex-wrap gap-4 items-center hidden shrink-0 shadow-sm z-10 transition-all">
            
            <!-- Search Bar -->
            <div class="relative flex-1 min-w-[200px] max-w-sm">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Search any text..." 
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-slate-50 outline-none text-sm transition-all"
                    onkeyup="handleSearch(this.value)">
            </div>

            <!-- Smart ID Button -->
            <button onclick="toggleIdGenerator()" class="px-3 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-medium rounded-md shadow-sm transition-colors text-sm border border-indigo-200" title="Generate Unique ID from Columns">
                <i class="fa-solid fa-fingerprint mr-1"></i> Generate ID
            </button>

            <!-- Column Manager Button -->
            <button onclick="toggleColumnManager()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-md shadow-sm transition-colors text-sm border border-slate-200">
                <i class="fa-solid fa-table-columns mr-1"></i> Columns
            </button>

            <div class="h-8 w-[1px] bg-slate-200 mx-2 hidden md:block"></div>

            <!-- Translation Tools -->
            <div class="flex flex-wrap gap-2 items-end flex-grow">
                <div class="w-40">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Column</label>
                    <select id="colSelect" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-indigo-500 outline-none">
                        <option value="" disabled selected>Select...</option>
                    </select>
                </div>

                <div class="w-56">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Translate Mode</label>
                    <select id="modeSelect" onchange="toggleApiKeyInput()" class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-indigo-500 outline-none">
                        <option value="gemini_api" class="font-bold text-indigo-600">✨ Gemini AI (Best Quality)</option>
                        <option value="date_full">Rule: Full Date (12 Jan -> ১২ জানু)</option>
                        <option value="number">Rule: Numbers Only (123 -> ১২৩)</option>
                        <option value="text">Rule: Month/Day Names</option>
                        <option value="general_api">Legacy Auto-Translate</option>
                    </select>
                </div>

                <!-- API Key Input (Hidden by default) -->
                <div id="apiKeyContainer" class="w-48 transition-all duration-300">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1 block flex justify-between">
                        <span>Gemini API Key</span>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-500 hover:text-indigo-700 cursor-pointer" title="Get Key"><i class="fa-solid fa-circle-info"></i></a>
                    </label>
                    <input type="password" id="apiKeyInput" placeholder="Paste Key Here..." class="w-full px-3 py-1.5 border border-slate-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-indigo-500 outline-none font-mono" value="AIzaSyCKjh4p9Ox1oPIgKpihDKqqj_7gTgz_wYA">
                </div>

                <button onclick="applyTranslation()" class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md shadow-sm transition-colors text-sm h-[34px] mt-auto">
                    Translate
                </button>
            </div>
        </div>

        <!-- ID Generator Panel (Hidden) -->
        <div id="idGenerator" class="bg-indigo-50 border-b border-indigo-200 p-4 hidden shrink-0 shadow-inner z-10 transition-all">
            <div class="flex justify-between items-start">
                <h3 class="text-xs font-bold text-indigo-800 uppercase tracking-wider mb-2">Generate Unique ID (Normalize Data)</h3>
                <button onclick="toggleIdGenerator()" class="text-indigo-400 hover:text-indigo-700"><i class="fa-solid fa-times"></i></button>
            </div>
            <p class="text-xs text-indigo-600 mb-3">Select columns to combine (e.g. Division + Zila) to create a unique ID for repeated locations.</p>
            
            <div id="idGenCheckboxes" class="flex flex-wrap gap-4 mb-4 max-h-32 overflow-y-auto p-2 bg-white rounded border border-indigo-100">
                <!-- Checkboxes injected here -->
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="idColName" value="Location_ID" class="px-3 py-1.5 border border-indigo-300 rounded text-sm w-40" placeholder="ID Column Name">
                <button onclick="generateSmartID()" class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs font-bold shadow-sm">
                    Generate IDs
                </button>
            </div>
        </div>

        <!-- Column Manager Panel (Hidden) -->
        <div id="columnManager" class="bg-slate-50 border-b border-slate-200 p-4 hidden shrink-0 shadow-inner z-10 transition-all">
            <div class="flex justify-between items-start mb-3">
                 <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Active Columns</h3>
                 <button onclick="toggleColumnManager()" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-times"></i></button>
            </div>
           
            <div class="flex flex-wrap gap-2 mb-4" id="activeColumnTagContainer">
                <!-- Active Tags injected here -->
            </div>
            
            <div id="hiddenColumnsArea" class="hidden mb-4 border-t border-slate-200 pt-3">
                <h3 class="text-xs font-bold text-red-400 uppercase tracking-wider mb-2">Hidden / Removed Columns (Click to Restore)</h3>
                <div class="flex flex-wrap gap-2" id="hiddenColumnTagContainer">
                    <!-- Hidden Tags injected here -->
                </div>
            </div>

            <div class="flex gap-2 max-w-sm mt-4 border-t border-slate-200 pt-3">
                <input type="text" id="newColInput" placeholder="New Column Name" class="flex-1 px-3 py-1.5 border border-slate-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-indigo-500 outline-none">
                <button onclick="addNewColumn()" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-md text-xs font-semibold transition-colors">
                    <i class="fa-solid fa-plus mr-1"></i> Add
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow overflow-hidden relative bg-slate-50">
            
            <!-- Upload Overlay -->
            <div id="uploadOverlay" class="absolute inset-0 flex items-center justify-center z-20 bg-slate-50">
                <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-2xl bg-white p-12 text-center transition-all duration-200 flex flex-col items-center justify-center w-3/4 max-w-lg cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 hover:shadow-lg">
                    <input type="file" id="fileInput" accept=".csv" class="hidden">
                    <div class="bg-indigo-100 text-indigo-600 rounded-full p-6 mb-6">
                        <i class="fa-solid fa-cloud-arrow-up text-4xl"></i>
                    </div>
                    <h3 class="font-bold text-xl text-slate-700 mb-2">Upload CSV File</h3>
                    <p class="text-slate-500 mb-6">Drag & drop or click to browse</p>
                    <div class="text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full">Supports .csv files</div>
                </div>
            </div>

            <!-- Loader -->
            <div id="loader" class="hidden absolute inset-0 z-30 bg-white/95 flex flex-col items-center justify-center backdrop-blur-sm">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-indigo-600 mb-4"></div>
                <p id="loaderText" class="text-slate-800 font-bold text-lg animate-pulse">Processing...</p>
                <p id="loaderSubText" class="text-slate-500 text-sm mt-2 font-mono bg-slate-100 px-2 py-1 rounded"></p>
            </div>

            <!-- Data Table -->
            <div id="tableContainer" class="w-full h-full overflow-auto hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-100 sticky top-0 z-10 shadow-sm">
                        <tr id="tableHeader">
                            <!-- Headers injected here -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-200 bg-white text-sm">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
            
            <!-- No Results State -->
            <div id="noResults" class="hidden absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 text-center">
                    <i class="fa-solid fa-filter-circle-xmark text-4xl text-slate-300 mb-3"></i>
                    <p class="text-slate-500 font-medium">No records match your search</p>
                </div>
            </div>

        </div>

        <!-- Footer / Stats -->
        <div class="bg-white border-t border-slate-200 p-3 flex justify-between items-center text-xs text-slate-500 shrink-0">
            <div class="flex gap-6">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-list-ol text-slate-400"></i>
                    <span id="rowCount">0 rows</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-table-columns text-slate-400"></i>
                    <span id="colCount">0 columns</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fa-regular fa-square text-slate-400"></i>
                    <span id="emptyCount">0 empty cells</span>
                </div>
            </div>
            <span id="statusText" class="italic">Ready</span>
        </div>

    </div>

    <script>
        // Data Dictionaries (Bangla)
        const bnDigits = {'0':'০','1':'১','2':'২','3':'৩','4':'৪','5':'৫','6':'৬','7':'৭','8':'৮','9':'৯'};
        const bnMonths = {
            'january':'জানুয়ারি', 'jan':'জানু',
            'february':'ফেব্রুয়ারি', 'feb':'ফেব্রু',
            'march':'মার্চ', 'mar':'মার্চ',
            'april':'এপ্রিল', 'apr':'এপ্রিল',
            'may':'মে',
            'june':'জুন', 'jun':'জুন',
            'july':'জুলাই', 'jul':'জুলাই',
            'august':'আগস্ট', 'aug':'আগস্ট',
            'september':'সেপ্টেম্বর', 'sep':'সেপ্টে',
            'october':'অক্টোবর', 'oct':'অক্টো',
            'november':'নভেম্বর', 'nov':'নভে',
            'december':'ডিসেম্বর', 'dec':'ডিসে'
        };
        const bnDays = {
            'saturday':'শনিবার', 'sat':'শনি',
            'sunday':'রবিবার', 'sun':'রবি',
            'monday':'সোমবার', 'mon':'সোম',
            'tuesday':'মঙ্গলবার', 'tue':'মঙ্গল',
            'wednesday':'বুধবার', 'wed':'বুধ',
            'thursday':'বৃহস্পতিবার', 'thu':'বৃহস্পতি',
            'friday':'শুক্রবার', 'fri':'শুক্র'
        };

        // App State
        let csvData = []; // Full Data
        let filteredData = []; // Search Result Data
        let headers = []; // Active Headers
        let hiddenHeaders = []; // Removed Headers (for restore)
        let fileName = "data";

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const uploadOverlay = document.getElementById('uploadOverlay');
        const toolbar = document.getElementById('toolbar');
        const tableContainer = document.getElementById('tableContainer');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const colSelect = document.getElementById('colSelect');
        const modeSelect = document.getElementById('modeSelect');
        const apiKeyContainer = document.getElementById('apiKeyContainer');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const loaderSubText = document.getElementById('loaderSubText');
        const noResults = document.getElementById('noResults');
        
        // Column Manager Elements
        const columnManager = document.getElementById('columnManager');
        const activeColumnTagContainer = document.getElementById('activeColumnTagContainer');
        const hiddenColumnTagContainer = document.getElementById('hiddenColumnTagContainer');
        const hiddenColumnsArea = document.getElementById('hiddenColumnsArea');
        const newColInput = document.getElementById('newColInput');
        
        // ID Generator Elements
        const idGenerator = document.getElementById('idGenerator');
        const idGenCheckboxes = document.getElementById('idGenCheckboxes');
        const idColNameInput = document.getElementById('idColName');

        // Export Elements
        const exportFormatSelect = document.getElementById('exportFormat');
        const btnExpCsv = document.getElementById('btnExpCsv');
        const btnExpJson = document.getElementById('btnExpJson');
        const btnExpJs = document.getElementById('btnExpJs');
        const btnExpPy = document.getElementById('btnExpPy');

        // Stats
        const statusText = document.getElementById('statusText');
        const rowCountSpan = document.getElementById('rowCount');
        const colCountSpan = document.getElementById('colCount');
        const emptyCountSpan = document.getElementById('emptyCount');

        // --- Event Listeners ---

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-active');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        // Initialize UI
        toggleApiKeyInput();

        // --- Core Functions ---

        function handleFile(file) {
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert("Please upload a valid CSV file.");
                return;
            }

            fileName = file.name.replace('.csv', '');
            showLoader(true, "Reading CSV...", "Parsing file structure");

            const reader = new FileReader();
            reader.onload = (e) => {
                setTimeout(() => {
                    parseCSV(e.target.result);
                }, 300);
            };
            reader.readAsText(file);
        }

        function toggleApiKeyInput() {
            const mode = modeSelect.value;
            if (mode === 'gemini_api') {
                apiKeyContainer.classList.remove('hidden');
            } else {
                apiKeyContainer.classList.add('hidden');
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r\n|\n/);
            if (lines.length === 0) {
                showLoader(false);
                return;
            }

            // Detect delimiter
            const firstLine = lines[0];
            const delimiter = (firstLine.match(/;/g) || []).length > (firstLine.match(/,/g) || []).length ? ';' : ',';

            headers = splitCSVLine(lines[0], delimiter);
            hiddenHeaders = []; // Reset hidden headers
            
            csvData = [];
            let emptyCells = 0;

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const row = splitCSVLine(lines[i], delimiter);
                
                let rowObj = {};
                headers.forEach((h, index) => {
                    const val = row[index] || "";
                    if (val === "") emptyCells++;
                    rowObj[h] = val;
                });
                csvData.push(rowObj);
            }

            filteredData = [...csvData]; // Init filtered data

            renderTable();
            updateStats(csvData.length, headers.length, emptyCells);
            updateUIState();
            showLoader(false);
        }

        function splitCSVLine(line, delimiter) {
            // Robust Regex for CSV splitting
            const pattern = new RegExp(
                "(\\" + delimiter + "|\\r?\\n|\\r|^)" +
                "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
                "([^\"\\" + delimiter + "\\r\\n]*))",
                "gi"
            );
            let matches = null;
            const row = [];
            while (matches = pattern.exec(line)) {
                let matchedValue;
                if (matches[2]) {
                    matchedValue = matches[2].replace(new RegExp("\"\"", "g"), "\"");
                } else {
                    matchedValue = matches[3];
                }
                if (matches[1] !== undefined || row.length === 0) {
                    row.push(matchedValue);
                }
            }
            if (!line.includes('"')) return line.split(delimiter);
            if (row.length > 0 && row[0] === undefined) row.shift(); 
            
            // Fallback for tricky lines if regex returns oddity
            let result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === delimiter && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function renderTable() {
            // Render Headers
            tableHeader.innerHTML = '';
            
            // Index Header
            const thIdx = document.createElement('th');
            thIdx.className = "px-4 py-3 font-semibold text-slate-500 bg-slate-100 border-b w-12 text-center";
            thIdx.innerText = "#";
            tableHeader.appendChild(thIdx);

            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = "px-4 py-3 font-semibold text-slate-600 bg-slate-100 border-b whitespace-nowrap";
                th.innerText = h;
                tableHeader.appendChild(th);
            });

            // Populate Column Select for Translation
            const currentSelection = colSelect.value;
            colSelect.innerHTML = '<option value="" disabled selected>Select column...</option>';
            headers.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.innerText = h;
                if (h === currentSelection) opt.selected = true;
                colSelect.appendChild(opt);
            });

            // Populate Column Manager Tags
            renderColumnTags();
            // Populate ID Generator Checkboxes
            renderIdGeneratorCheckboxes();

            // Render Body
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                noResults.classList.remove('hidden');
                return;
            } else {
                noResults.classList.add('hidden');
            }

            // Lazy render limit for performance
            const displayLimit = Math.min(filteredData.length, 200); 
            
            for(let i=0; i<displayLimit; i++) {
                const row = filteredData[i];
                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50 group";
                
                // Index Cell
                const tdIdx = document.createElement('td');
                tdIdx.className = "px-4 py-2 text-xs text-slate-400 border-r border-slate-100 text-center bg-slate-50 group-hover:bg-indigo-100";
                tdIdx.innerText = i + 1;
                tr.appendChild(tdIdx);

                headers.forEach(h => {
                    const td = document.createElement('td');
                    const val = row[h];
                    const isBangla = /[\u0980-\u09FF]/.test(val);
                    
                    td.className = `px-4 py-2 whitespace-nowrap border-b border-slate-100 text-slate-700 ${isBangla ? 'bn-font' : ''}`;
                    td.innerText = val !== undefined ? val : "";
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            }
            
            if (filteredData.length > 200) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="${headers.length + 1}" class="text-center py-4 text-xs text-slate-400 italic">Showing first 200 of ${filteredData.length} rows...</td>`;
                tableBody.appendChild(tr);
            }

            // Update stats
            updateStats(filteredData.length, headers.length, countEmptyCells());
        }

        function countEmptyCells() {
            let count = 0;
            filteredData.forEach(row => {
                headers.forEach(h => {
                    if (!row[h]) count++;
                });
            });
            return count;
        }

        // --- Column Manager Logic ---

        function toggleColumnManager() {
            columnManager.classList.toggle('hidden');
            idGenerator.classList.add('hidden'); // close other panels
        }

        function renderColumnTags() {
            // Active Tags
            activeColumnTagContainer.innerHTML = '';
            headers.forEach(h => {
                const tag = document.createElement('div');
                tag.className = 'col-tag inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 border border-indigo-200';
                tag.innerHTML = `
                    <span class="mr-2">${h}</span>
                    <button onclick="renameColumn('${h}')" class="text-indigo-400 hover:text-blue-600 mr-2 focus:outline-none" title="Rename">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button onclick="removeColumn('${h}')" class="text-indigo-400 hover:text-red-500 focus:outline-none" title="Hide/Remove">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                activeColumnTagContainer.appendChild(tag);
            });

            // Hidden Tags
            hiddenColumnTagContainer.innerHTML = '';
            if (hiddenHeaders.length > 0) {
                hiddenColumnsArea.classList.remove('hidden');
                hiddenHeaders.forEach(h => {
                    const tag = document.createElement('div');
                    tag.className = 'col-tag inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200 cursor-pointer hover:bg-red-200';
                    tag.title = "Click to Restore";
                    tag.onclick = () => restoreColumn(h);
                    tag.innerHTML = `<i class="fa-solid fa-rotate-left mr-2"></i> ${h}`;
                    hiddenColumnTagContainer.appendChild(tag);
                });
            } else {
                hiddenColumnsArea.classList.add('hidden');
            }
        }

        function removeColumn(colName) {
            if (headers.length <= 1) {
                alert("Cannot hide the last column.");
                return;
            }
            // Move from headers to hiddenHeaders
            headers = headers.filter(h => h !== colName);
            hiddenHeaders.push(colName);
            renderTable();
        }

        function restoreColumn(colName) {
            hiddenHeaders = hiddenHeaders.filter(h => h !== colName);
            headers.push(colName);
            renderTable();
        }

        function renameColumn(oldName) {
            const newName = prompt("Enter new column name:", oldName);
            if (newName && newName.trim() !== "" && newName !== oldName) {
                if (headers.includes(newName)) {
                    alert("A column with this name already exists.");
                    return;
                }
                
                // Update headers array
                const idx = headers.indexOf(oldName);
                headers[idx] = newName;

                // Update ALL data objects
                csvData.forEach(row => {
                    row[newName] = row[oldName];
                    delete row[oldName];
                });

                // Update hidden headers list if needed? No, renaming only happens on active.
                renderTable();
            }
        }

        function addNewColumn() {
            const name = newColInput.value.trim();
            if (!name) return;
            if (headers.includes(name)) {
                alert("Column name already exists.");
                return;
            }

            headers.push(name);
            // Add empty field to all rows
            csvData.forEach(row => row[name] = "");
            
            newColInput.value = '';
            renderTable();
        }

        // --- ID Generator Logic ---

        function toggleIdGenerator() {
            idGenerator.classList.toggle('hidden');
            columnManager.classList.add('hidden'); // close other panels
        }

        function renderIdGeneratorCheckboxes() {
            idGenCheckboxes.innerHTML = '';
            headers.forEach(h => {
                const label = document.createElement('label');
                label.className = "flex items-center text-xs text-slate-700 cursor-pointer bg-slate-50 px-2 py-1 rounded border border-slate-200 hover:bg-slate-100";
                label.innerHTML = `
                    <input type="checkbox" value="${h}" class="id-gen-check mr-2 accent-indigo-600">
                    ${h}
                `;
                idGenCheckboxes.appendChild(label);
            });
        }

        function generateSmartID() {
            const checkboxes = document.querySelectorAll('.id-gen-check:checked');
            if (checkboxes.length === 0) {
                alert("Please select at least one column to combine.");
                return;
            }

            const selectedCols = Array.from(checkboxes).map(cb => cb.value);
            const idColName = idColNameInput.value.trim() || "Location_ID";

            if (headers.includes(idColName)) {
                if(!confirm(`Column "${idColName}" already exists. Overwrite?`)) return;
            } else {
                headers.unshift(idColName); // Add ID to start
            }

            // Generation Logic
            const uniqueMap = new Map();
            let counter = 1;

            csvData.forEach(row => {
                // Create key from selected columns
                const key = selectedCols.map(c => String(row[c] || "").trim().toLowerCase()).join('|');
                
                if (!uniqueMap.has(key)) {
                    // Generate new ID (e.g. LOC_001)
                    const idStr = "LOC_" + String(counter).padStart(3, '0');
                    uniqueMap.set(key, idStr);
                    counter++;
                }

                row[idColName] = uniqueMap.get(key);
            });

            renderTable();
            toggleIdGenerator(); // Close panel
            statusText.innerText = `Generated ${counter - 1} unique IDs based on ${selectedCols.join('+')}`;
        }

        // --- Search Logic ---
        
        let searchTimeout;
        function handleSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(query.toLowerCase());
            }, 300); // Debounce
        }

        function performSearch(query) {
            if (!query) {
                filteredData = [...csvData];
            } else {
                filteredData = csvData.filter(row => {
                    return Object.values(row).some(val => 
                        String(val).toLowerCase().includes(query)
                    );
                });
            }
            renderTable();
            // Update row count in stats for filtered view
            rowCountSpan.innerText = `${filteredData.length} / ${csvData.length} rows`;
        }


        // --- Translation Logic ---

        async function applyTranslation() {
            const targetCol = colSelect.value;
            const mode = document.getElementById('modeSelect').value;

            if (!targetCol) {
                alert("Please select a column to translate first.");
                return;
            }

            let changeCount = 0;
            const apiKey = document.getElementById('apiKeyInput').value.trim();

            if (mode === 'gemini_api') {
                if (!apiKey) {
                    alert("Please enter your Gemini API Key in the box provided.");
                    return;
                }

                // GEMINI AI MODE (Async)
                showLoader(true, "Gemini is thinking...", "Starting AI Translation...");
                
                for (let i = 0; i < csvData.length; i++) {
                    const row = csvData[i];
                    let val = row[targetCol];
                    
                    // Skip if already Bangla or empty
                    if (!val || /[\u0980-\u09FF]/.test(val)) continue;

                    // Update loader frequently
                    showLoader(true, "Translating with Gemini...", `Row ${i + 1} of ${csvData.length}`);
                    
                    // Rate Limit Safety (Simple Delay)
                    await new Promise(r => setTimeout(r, 200)); 

                    try {
                        let translated = await translateWithGemini(val, apiKey);
                        if (translated && translated !== val) {
                            row[targetCol] = translated;
                            changeCount++;
                        }
                    } catch (e) {
                        console.log("Gemini Error", e);
                    }
                }

            } else if (mode === 'general_api') {
                // LEGACY API MODE (Async)
                showLoader(true, "Auto-Translating...", "Connecting to MyMemory Service...");
                
                for (let i = 0; i < csvData.length; i++) {
                    const row = csvData[i];
                    let val = row[targetCol];
                    
                    if (!val || /[\u0980-\u09FF]/.test(val)) continue;

                    if (i % 5 === 0) {
                        showLoader(true, "Translating...", `Row ${i + 1} of ${csvData.length}`);
                        await new Promise(r => setTimeout(r, 10));
                    }

                    try {
                        let translated = await translateViaLegacyAPI(val);
                        if (translated && translated !== val) {
                            row[targetCol] = translated;
                            changeCount++;
                        }
                    } catch (e) {
                        console.log("Legacy API Error", e);
                    }
                }

            } else {
                // RULE-BASED MODE (Sync/Fast)
                showLoader(true, "Translating...", "Applying dictionary rules");
                await new Promise(r => setTimeout(r, 100));

                csvData.forEach(row => {
                    let val = row[targetCol];
                    if (!val) return;
                    
                    let original = val.toString();
                    let translated = original;

                    if (mode === 'number') {
                        translated = translateNumbers(original);
                    } else if (mode === 'text') {
                        translated = translateText(original); 
                    } else if (mode === 'date_full') {
                        translated = translateText(original);
                        translated = translateNumbers(translated);
                    }

                    if (translated !== original) {
                        row[targetCol] = translated;
                        changeCount++;
                    }
                });
            }

            // Re-apply search filter if active
            const query = document.getElementById('searchInput').value.toLowerCase();
            performSearch(query);
            
            showLoader(false);
            statusText.innerText = `Translation complete! ${changeCount} cells updated.`;
        }

        async function translateWithGemini(text, apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{
                        text: `Translate the following text from English to Bangla. Return ONLY the translated text, no explanations, no markdown. Text: "${text}"` 
                    }]
                }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error('API Request Failed');
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return text; 
            }
        }

        async function translateViaLegacyAPI(text) {
            try {
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|bn`;
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.responseData && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                }
                return text;
            } catch (error) {
                return text;
            }
        }

        function translateNumbers(str) {
            return str.replace(/[0-9]/g, (match) => bnDigits[match]);
        }

        function translateText(str) {
            let result = str;
            // Months
            for (let [eng, bn] of Object.entries(bnMonths)) {
                const regex = new RegExp(`\\b${eng}\\b`, 'gi');
                if (regex.test(result)) result = result.replace(regex, bn);
            }
            // Days
            for (let [eng, bn] of Object.entries(bnDays)) {
                const regex = new RegExp(`\\b${eng}\\b`, 'gi');
                if (regex.test(result)) result = result.replace(regex, bn);
            }
            return result;
        }

        // --- Export Logic ---

        function triggerDownload(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getFormattedString(data, format) {
            // Filter fields based on active headers
            const exportData = data.map(row => {
                const newRow = {};
                headers.forEach(h => {
                    newRow[h] = row[h] !== undefined ? row[h] : "";
                });
                return newRow;
            });

            if (format === 'pretty') {
                return JSON.stringify(exportData, null, 2);
            } else if (format === 'single') {
                return JSON.stringify(exportData);
            } else if (format === 'lines') {
                const items = exportData.map(item => JSON.stringify(item));
                return "[\n  " + items.join(",\n  ") + "\n]";
            }
            return JSON.stringify(exportData);
        }

        function downloadCSV() {
            if (filteredData.length === 0) return;
            const headerRow = headers.join(',') + '\n';
            const bodyRows = filteredData.map(rowObj => {
                return headers.map(h => {
                    let val = rowObj[h];
                    if (val && (val.includes('"') || val.includes(',') || val.includes('\n'))) {
                        val = `"${val.replace(/"/g, '""')}"`;
                    }
                    return val !== undefined ? val : "";
                }).join(',');
            }).join('\n');
            const csvContent = "\ufeff" + headerRow + bodyRows; 
            triggerDownload(csvContent, `${fileName}_edited.csv`, 'text/csv;charset=utf-8;');
        }

        function downloadJSON() {
            if (filteredData.length === 0) return;
            const format = exportFormatSelect.value;
            const jsonContent = getFormattedString(filteredData, format);
            triggerDownload(jsonContent, `${fileName}.json`, 'application/json');
        }

        function downloadJS() {
            if (filteredData.length === 0) return;
            const format = exportFormatSelect.value;
            const dataStr = getFormattedString(filteredData, format);
            const jsContent = `// Exported Data from Mega CSV Tool\nexport const ${fileName.replace(/[^a-zA-Z0-9]/g, '_')} = ${dataStr};`;
            triggerDownload(jsContent, `${fileName}.js`, 'text/javascript');
        }

        function downloadPython() {
            if (filteredData.length === 0) return;
            const format = exportFormatSelect.value;
            let pyStr = getFormattedString(filteredData, format);
            
            pyStr = pyStr.replace(/null/g, 'None')
                         .replace(/true/g, 'True')
                         .replace(/false/g, 'False');
            
            const pyContent = `# Exported Data from Mega CSV Tool\n\ndata = ${pyStr}\n`;
            triggerDownload(pyContent, `${fileName}.py`, 'text/x-python');
        }

        // --- UI Helpers ---

        function updateUIState() {
            uploadOverlay.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            toolbar.classList.remove('hidden');
            toolbar.classList.add('flex');
            
            // Enable exports
            [btnExpCsv, btnExpJson, btnExpJs, btnExpPy].forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-30');
            });
        }

        function updateStats(rows, cols, empty) {
            rowCountSpan.innerText = `${rows} rows`;
            colCountSpan.innerText = `${cols} columns`;
            emptyCountSpan.innerText = `${empty} empty cells`;
        }

        function resetApp() {
            location.reload();
        }

        function showLoader(show, text="Processing...", subtext="") {
            if (show) {
                loader.classList.remove('hidden');
                loaderText.innerText = text;
                loaderSubText.innerText = subtext;
            } else {
                loader.classList.add('hidden');
            }
        }

    </script>
</body>
</html>
