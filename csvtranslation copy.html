<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV English to Bangla Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green tint */
        }

        /* Bangla Font */
        .bn-font {
            font-family: 'Hind Siliguri', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #86efac; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4ade80; 
        }

        .drag-active {
            border-color: #16a34a !important;
            background-color: #dcfce7 !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4 text-slate-800">

    <div class="max-w-7xl w-full bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col h-[90vh]">
        
        <!-- Header -->
        <div class="bg-green-800 text-white p-6 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-3">
                    <i class="fa-solid fa-language text-yellow-400"></i>
                    <span>English <i class="fa-solid fa-arrow-right text-green-300 text-sm mx-1"></i> Bangla CSV Translator</span>
                </h1>
                <p class="text-green-200 text-sm mt-1">Translate Dates, Numbers, and Months in your CSV files.</p>
            </div>
            <div class="flex gap-3">
                 <button onclick="resetApp()" class="px-4 py-2 text-green-100 hover:text-white hover:bg-green-700 rounded-lg transition-colors text-sm font-medium">
                    <i class="fa-solid fa-rotate-right mr-1"></i> New File
                </button>
                <button id="btnDownload" onclick="downloadCSV()" disabled class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-transform active:scale-95">
                    <i class="fa-solid fa-file-export mr-2"></i> Download CSV
                </button>
            </div>
        </div>

        <!-- Toolbar (Only visible after upload) -->
        <div id="toolbar" class="bg-white border-b border-slate-200 p-4 flex flex-wrap gap-4 items-end hidden shrink-0 shadow-sm z-10">
            
            <div class="flex-1 min-w-[200px]">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 block">Target Column</label>
                <div class="relative">
                    <i class="fa-solid fa-table-columns absolute left-3 top-3 text-slate-400"></i>
                    <select id="colSelect" class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-slate-50 outline-none text-sm font-medium">
                        <option value="" disabled selected>Select a column...</option>
                    </select>
                </div>
            </div>

            <div class="flex-1 min-w-[200px]">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 block">Translation Mode</label>
                <div class="relative">
                    <i class="fa-solid fa-wand-magic-sparkles absolute left-3 top-3 text-slate-400"></i>
                    <select id="modeSelect" class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-slate-50 outline-none text-sm font-medium">
                        <option value="date_full">Full Date (12 Jan 2024 → ১২ জানু ২০২৪)</option>
                        <option value="number">Numbers Only (123.45 → ১২৩.৪৫)</option>
                        <option value="text">Month/Day Names Only (July → জুলাই)</option>
                    </select>
                </div>
            </div>

            <button onclick="applyTranslation()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition-colors h-[42px]">
                Translate Column
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow overflow-hidden relative bg-slate-50">
            
            <!-- Upload Overlay -->
            <div id="uploadOverlay" class="absolute inset-0 flex items-center justify-center z-20 bg-slate-50">
                <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-2xl bg-white p-12 text-center transition-all duration-200 flex flex-col items-center justify-center w-3/4 max-w-lg cursor-pointer hover:border-green-400 hover:bg-green-50 hover:shadow-lg">
                    <input type="file" id="fileInput" accept=".csv" class="hidden">
                    <div class="bg-green-100 text-green-600 rounded-full p-6 mb-6">
                        <i class="fa-solid fa-cloud-arrow-up text-4xl"></i>
                    </div>
                    <h3 class="font-bold text-xl text-slate-700 mb-2">Upload your CSV File</h3>
                    <p class="text-slate-500 mb-6">Drag & drop or click to browse</p>
                    <div class="text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full">Supports .csv files</div>
                </div>
            </div>

            <!-- Loader -->
            <div id="loader" class="hidden absolute inset-0 z-30 bg-white/90 flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mb-4"></div>
                <p id="loaderText" class="text-green-800 font-medium animate-pulse">Processing...</p>
            </div>

            <!-- Data Table -->
            <div id="tableContainer" class="w-full h-full overflow-auto hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-100 sticky top-0 z-10 shadow-sm">
                        <tr id="tableHeader">
                            <!-- Headers injected here -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-200 bg-white">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>

        </div>

        <!-- Footer / Status -->
        <div class="bg-white border-t border-slate-200 p-3 flex justify-between items-center text-xs text-slate-500 shrink-0">
            <span id="statusText">Waiting for file...</span>
            <div class="flex gap-4">
                <span id="rowCount">0 rows</span>
                <span id="colCount">0 columns</span>
            </div>
        </div>

    </div>

    <script>
        // Data Dictionaries
        const bnDigits = {'0':'০','1':'১','2':'২','3':'৩','4':'৪','5':'৫','6':'৬','7':'৭','8':'৮','9':'৯'};
        const bnMonths = {
            'january':'জানুয়ারি', 'jan':'জানু',
            'february':'ফেব্রুয়ারি', 'feb':'ফেব্রু',
            'march':'মার্চ', 'mar':'মার্চ',
            'april':'এপ্রিল', 'apr':'এপ্রিল',
            'may':'মে',
            'june':'জুন', 'jun':'জুন',
            'july':'জুলাই', 'jul':'জুলাই',
            'august':'আগস্ট', 'aug':'আগস্ট',
            'september':'সেপ্টেম্বর', 'sep':'সেপ্টে',
            'october':'অক্টোবর', 'oct':'অক্টো',
            'november':'নভেম্বর', 'nov':'নভে',
            'december':'ডিসেম্বর', 'dec':'ডিসে'
        };
        const bnDays = {
            'saturday':'শনিবার', 'sat':'শনি',
            'sunday':'রবিবার', 'sun':'রবি',
            'monday':'সোমবার', 'mon':'সোম',
            'tuesday':'মঙ্গলবার', 'tue':'মঙ্গল',
            'wednesday':'বুধবার', 'wed':'বুধ',
            'thursday':'বৃহস্পতিবার', 'thu':'বৃহস্পতি',
            'friday':'শুক্রবার', 'fri':'শুক্র'
        };

        // App State
        let csvData = []; // Array of Objects
        let headers = []; // Array of Strings
        let fileName = "translated_data";

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const uploadOverlay = document.getElementById('uploadOverlay');
        const toolbar = document.getElementById('toolbar');
        const tableContainer = document.getElementById('tableContainer');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const colSelect = document.getElementById('colSelect');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const btnDownload = document.getElementById('btnDownload');
        const statusText = document.getElementById('statusText');
        const rowCountSpan = document.getElementById('rowCount');
        const colCountSpan = document.getElementById('colCount');

        // --- Event Listeners ---

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-active');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        // --- Core Functions ---

        function handleFile(file) {
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert("Please upload a valid CSV file.");
                return;
            }

            fileName = file.name.replace('.csv', '');
            showLoader(true, "Reading CSV...");

            const reader = new FileReader();
            reader.onload = (e) => {
                setTimeout(() => {
                    parseCSV(e.target.result);
                }, 500);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            // Simple parsing logic handling quoted fields
            const lines = text.trim().split(/\r\n|\n/);
            if (lines.length === 0) {
                showLoader(false);
                return;
            }

            // Detect delimiter
            const firstLine = lines[0];
            const delimiter = (firstLine.match(/;/g) || []).length > (firstLine.match(/,/g) || []).length ? ';' : ',';

            // Split Header
            headers = splitCSVLine(lines[0], delimiter);
            
            // Split Body
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const row = splitCSVLine(lines[i], delimiter);
                
                // Create object mapping header -> value
                let rowObj = {};
                headers.forEach((h, index) => {
                    rowObj[h] = row[index] || "";
                });
                csvData.push(rowObj);
            }

            renderTable();
            updateUIState();
            showLoader(false);
        }

        // Robust line splitter for CSV (handles commas inside quotes)
        function splitCSVLine(line, delimiter) {
            const pattern = new RegExp(
                "(\\" + delimiter + "|\\r?\\n|\\r|^)" +
                "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
                "([^\"\\" + delimiter + "\\r\\n]*))",
                "gi"
            );
            let matches = null;
            const row = [];
            while (matches = pattern.exec(line)) {
                let matchedValue;
                if (matches[2]) {
                    matchedValue = matches[2].replace(new RegExp("\"\"", "g"), "\"");
                } else {
                    matchedValue = matches[3];
                }
                if (matches[1] !== undefined || row.length === 0) { // Push valid matches
                    row.push(matchedValue);
                }
            }
            // The regex might push an undefined first element or empty string depending on start, usually need to slice if first char is delim, but for standard CSV:
            // This regex logic pushes an empty string for the first match if the line starts with a value, we need to be careful.
            // Simplified approach for display:
            
            // Fallback for visual simplicity if regex fails or is too complex for basic usage:
            // If simple split works (no quotes), use it. Else regex.
            if (!line.includes('"')) return line.split(delimiter);
            
            // Use the regex result from above properly:
            // Filter out the initial empty match if it exists due to logic
             if (row.length > 0 && row[0] === undefined) row.shift(); 
             
             // Actually, let's use a simpler split for display to ensure it works for user
             // Re-implementing a simple parser
             let result = [];
             let current = '';
             let inQuotes = false;
             for (let i = 0; i < line.length; i++) {
                 const char = line[i];
                 if (char === '"') {
                     inQuotes = !inQuotes;
                 } else if (char === delimiter && !inQuotes) {
                     result.push(current);
                     current = '';
                 } else {
                     current += char;
                 }
             }
             result.push(current);
             return result;
        }

        function renderTable() {
            // Render Headers
            tableHeader.innerHTML = '';
            // Add Index Column
            const thIdx = document.createElement('th');
            thIdx.className = "px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 bg-slate-50 w-16";
            thIdx.innerText = "#";
            tableHeader.appendChild(thIdx);

            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = "px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 bg-slate-50 whitespace-nowrap";
                th.innerText = h;
                tableHeader.appendChild(th);
            });

            // Populate Column Select
            colSelect.innerHTML = '<option value="" disabled selected>Select a column...</option>';
            headers.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.innerText = h;
                colSelect.appendChild(opt);
            });

            // Render Body (First 500 rows for performance if large)
            tableBody.innerHTML = '';
            const displayLimit = Math.min(csvData.length, 500); // Optimization
            
            for(let i=0; i<displayLimit; i++) {
                const row = csvData[i];
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                
                // Index
                const tdIdx = document.createElement('td');
                tdIdx.className = "px-6 py-4 whitespace-nowrap text-xs text-slate-400 border-r border-slate-100";
                tdIdx.innerText = i + 1;
                tr.appendChild(tdIdx);

                headers.forEach(h => {
                    const td = document.createElement('td');
                    // Check if content looks like Bangla to apply font
                    const val = row[h];
                    const isBangla = /[\u0980-\u09FF]/.test(val);
                    
                    td.className = `px-6 py-4 whitespace-nowrap text-sm text-slate-700 border-b border-slate-100 ${isBangla ? 'bn-font' : ''}`;
                    td.innerText = val;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            }
            
            if (csvData.length > 500) {
                statusText.innerText = `Showing first 500 rows of ${csvData.length}`;
            } else {
                statusText.innerText = `Loaded successfully`;
            }
        }

        function updateUIState() {
            uploadOverlay.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            toolbar.classList.remove('hidden');
            toolbar.classList.add('flex');
            
            btnDownload.disabled = false;
            rowCountSpan.innerText = `${csvData.length} rows`;
            colCountSpan.innerText = `${headers.length} columns`;
        }

        function resetApp() {
            location.reload();
        }

        function showLoader(show, text="Processing...") {
            if (show) {
                loader.classList.remove('hidden');
                loaderText.innerText = text;
            } else {
                loader.classList.add('hidden');
            }
        }

        // --- Translation Logic ---

        function applyTranslation() {
            const targetCol = colSelect.value;
            const mode = document.getElementById('modeSelect').value;

            if (!targetCol) {
                alert("Please select a column to translate first.");
                return;
            }

            showLoader(true, "Translating Data...");

            // Process inside timeout to allow UI to render loader
            setTimeout(() => {
                let changeCount = 0;
                
                csvData.forEach(row => {
                    let val = row[targetCol];
                    if (!val) return;
                    
                    let original = val.toString();
                    let translated = original;

                    if (mode === 'number') {
                        translated = translateNumbers(original);
                    } else if (mode === 'text') {
                        translated = translateText(original); // Just months/days
                    } else if (mode === 'date_full') {
                        // Combined strategy for dates
                        translated = translateText(original); // First months/days
                        translated = translateNumbers(translated); // Then numbers
                    }

                    if (translated !== original) {
                        row[targetCol] = translated;
                        changeCount++;
                    }
                });

                renderTable(); // Re-render table with changes
                showLoader(false);
                statusText.innerText = `Translation complete! ${changeCount} cells updated.`;
                
                // Highlight the download button
                btnDownload.classList.add('animate-bounce');
                setTimeout(() => btnDownload.classList.remove('animate-bounce'), 1000);

            }, 100);
        }

        function translateNumbers(str) {
            return str.replace(/[0-9]/g, (match) => bnDigits[match]);
        }

        function translateText(str) {
            let lower = str.toLowerCase();
            let result = str;

            // Check Month Keys
            for (let [eng, bn] of Object.entries(bnMonths)) {
                // Use Word boundary regex for safer replacement
                // e.g. "May" matches "May" but not "Maybe" (though unlikely in date col)
                const regex = new RegExp(`\\b${eng}\\b`, 'gi');
                if (regex.test(result)) {
                    result = result.replace(regex, bn);
                }
            }

            // Check Day Keys
            for (let [eng, bn] of Object.entries(bnDays)) {
                const regex = new RegExp(`\\b${eng}\\b`, 'gi');
                if (regex.test(result)) {
                    result = result.replace(regex, bn);
                }
            }

            return result;
        }

        // --- Export Logic ---

        function downloadCSV() {
            if (csvData.length === 0) return;

            // 1. Create CSV String
            const headerRow = headers.join(',') + '\n';
            const bodyRows = csvData.map(rowObj => {
                return headers.map(h => {
                    let val = rowObj[h];
                    // Escape quotes if present
                    if (val.includes('"') || val.includes(',') || val.includes('\n')) {
                        val = `"${val.replace(/"/g, '""')}"`;
                    }
                    return val;
                }).join(',');
            }).join('\n');

            const csvContent = "\ufeff" + headerRow + bodyRows; // Add BOM for Excel UTF-8 support

            // 2. Trigger Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `${fileName}_bangla.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>