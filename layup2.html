<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>কর্মবিরতির তথ্য - ১০ম গ্রেড বাস্তবায়ন পরিষদ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-emerald-600 text-white p-2 rounded-lg">
                    <i data-lucide="database" class="w-5 h-5"></i>
                </div>
                <h1 class="font-bold text-lg text-slate-800">কর্মবিরতির তথ্য</h1>
            </div>
            <div class="text-sm text-slate-500">
                মোট: <span id="totalCount" class="font-bold text-emerald-600">0</span> প্রতিষ্ঠান
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">

        <!-- Search & Filter Controls -->
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6 space-y-4">

            <!-- Top Row: Search and Back Button -->
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <!-- Back Button -->
                <a href="index.html" class="flex items-center gap-2 text-slate-500 hover:text-slate-900 font-bold bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-lg transition-all text-sm whitespace-nowrap">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> পিছনে যান
                </a>

                <!-- Search Box -->
                <div class="relative w-full">
                    <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-5 h-5"></i>
                    <input type="text" id="searchInput" placeholder="প্রতিষ্ঠান বা এলাকা দিয়ে খুঁজুন..." 
                        class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 transition-all">
                </div>

                <!-- Refresh Button -->
                <button onclick="fetchData()" class="flex items-center gap-2 text-sm font-medium text-emerald-600 hover:bg-emerald-50 px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> রিফ্রেশ
                </button>
            </div>

            <!-- Filter Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 pt-2 border-t border-slate-100">
                <!-- Division Filter -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">বিভাগ</label>
                    <select id="filterDivision" onchange="applyFilters()" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:border-emerald-500">
                        <option value="">সকল বিভাগ</option>
                    </select>
                </div>

                <!-- District Filter -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">জেলা</label>
                    <select id="filterDistrict" onchange="applyFilters()" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:border-emerald-500">
                        <option value="">সকল জেলা</option>
                    </select>
                </div>

                <!-- Upazila Filter -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">উপজেলা</label>
                    <select id="filterUpazila" onchange="applyFilters()" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:border-emerald-500">
                        <option value="">সকল উপজেলা</option>
                    </select>
                </div>

                <!-- Reset Button -->
                <div class="flex items-end">
                    <button onclick="resetFilters()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="x-circle" class="w-4 h-4"></i> রিসেট ফিল্টার
                    </button>
                </div>
            </div>
        </div>


        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="animate-spin w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-slate-500">ডাটা লোড হচ্ছে...</p>
        </div>

        <!-- Data Grid -->
        <div id="dataContainer" class="hidden">

            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto bg-white rounded-xl shadow-sm border border-slate-200">
                <table class="w-full text-left border-collapse table-fixed">
                    <thead class="bg-slate-50 text-slate-600 text-sm uppercase">
                        <tr>
                            <th class="p-4 font-bold border-b w-[40%]">পূর্ণ ঠিকানা</th>
                            <th class="p-4 font-bold border-b w-[30%]">মন্তব্য</th>
                            <th class="p-4 font-bold border-b w-[30%]">আন্দোলনের ছবি</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm divide-y divide-slate-100">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div id="mobileCards" class="md:hidden grid gap-4">
                <!-- Cards will be inserted here -->
            </div>

        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16 bg-white rounded-xl border border-dashed border-slate-300">
            <i data-lucide="inbox" class="w-12 h-12 text-slate-300 mx-auto mb-3"></i>
            <p class="text-slate-500">কোনো তথ্য পাওয়া যায়নি</p>
        </div>

    </div>

    <!--Dev info-->
    <div class="text-center pb-8 mt-8">
        <p class="text-slate-500 text-xs mb-3">© ২০২৫ ১০ম গ্রেড বাস্তবায়ন পরিষদ</p>
        <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-slate-100 border border-slate-200 text-[10px] text-slate-500">
            <i data-lucide="code-2" class="w-3 h-3 text-emerald-500"></i>
            <span>Developed by</span>
            <a href="dev.html" class="font-bold text-emerald-600 hover:text-emerald-700">MR. H</a>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white bg-white/10 hover:bg-white/20 p-2 rounded-full transition-all" onclick="closeModal()">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <div class="relative max-w-5xl w-full max-h-screen flex justify-center" onclick="event.stopPropagation()">
             <img id="previewImage" src="" alt="Preview" class="max-w-full max-h-[85vh] rounded-md shadow-2xl object-contain">
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- API CONFIGURATION ---
        const API_KEY = 'AIzaSyDTvwDm19m-xtkMuALsspEJB-NNYV0kdUg'; 
        const SHEET_ID = '1lAgWuhQpBJE-NyrdnNiRxkbS5NdaB6zwOwb2agJAwRc';
        const SHEET_NAME = 'File-Received';

        const DATA_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;

        let allData = [];
        let filteredData = [];

        // Helper: Convert Google Drive Links to Direct Image Links
        function getDirectImageLink(url) {
            if (!url) return null;
            url = url.trim();

            // Handle Google Drive Links
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                let id = null;
                // Match /d/ID pattern
                let parts = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (parts && parts[1]) {
                    id = parts[1];
                } else {
                    // Match id=ID pattern
                    parts = url.match(/id=([a-zA-Z0-9_-]+)/);
                    if (parts && parts[1]) {
                        id = parts[1];
                    }
                }

                if (id) {
                    // lh3.googleusercontent.com is much faster and reliable for images than drive.google.com/uc
                    return `https://lh3.googleusercontent.com/d/${id}`;
                }
            }
            return url;
        }

        // Fetch Data Function
        async function fetchData() {
            const loading = document.getElementById('loadingState');
            const container = document.getElementById('dataContainer');
            const empty = document.getElementById('emptyState');

            loading.classList.remove('hidden');
            container.classList.add('hidden');
            empty.classList.add('hidden');

            try {
                const response = await fetch(DATA_URL);
                const result = await response.json();

                if (result.values && result.values.length > 0) {
                    const rows = result.values;

                    allData = rows.slice(1).map(row => {
                        // Extract all potential link cells starting from column 11 (Index L onwards)
                        // Also split comma-separated links within a single cell
                        let extractedLinks = [];
                        const rawCells = row.slice(11) || [];
                        
                        rawCells.forEach(cell => {
                            if (cell && typeof cell === 'string') {
                                // Split by comma or whitespace in case multiple links are pasted in one cell
                                const potentials = cell.split(/[\s,]+/).filter(u => u.startsWith('http'));
                                extractedLinks.push(...potentials);
                            }
                        });

                        // Convert to direct links
                        const validLinks = extractedLinks
                            .map(link => getDirectImageLink(link))
                            .filter(link => link !== null);

                        return {
                            Institute: row[9] || "",
                            Upazila: row[8] || "",
                            District: row[7] || "",
                            Division: row[6] || "",
                            Comment: row[10] || "",
                            File_Links: validLinks 
                        };
                    });

                    // Basic cleaning
                    allData = allData.filter(item => item.District || item.Institute).reverse();
                } else {
                    allData = [];
                }

                populateFilterOptions();
                filteredData = allData;
                renderData(filteredData);

                loading.classList.add('hidden');
                if(allData.length === 0) empty.classList.remove('hidden');
                else container.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching data:", error);
                loading.innerHTML = `<p class="text-red-500">ডাটা লোড করতে সমস্যা হয়েছে।</p>`;
            }
        }

        // --- Filter Logic ---
        function populateFilterOptions() {
            const divSelect = document.getElementById('filterDivision');
            const divisions = [...new Set(allData.map(item => item.Division).filter(Boolean))].sort();
            divSelect.innerHTML = '<option value="">সকল বিভাগ</option>';
            divisions.forEach(d => divSelect.add(new Option(d, d)));
            updateCascadingFilters('none');
        }

        function updateCascadingFilters(changedLevel) {
            const divSelect = document.getElementById('filterDivision');
            const distSelect = document.getElementById('filterDistrict');
            const upaSelect = document.getElementById('filterUpazila');

            const selectedDiv = divSelect.value;
            const selectedDist = distSelect.value;

            if (changedLevel === 'division' || changedLevel === 'none') {
                const availableDistricts = [...new Set(allData
                    .filter(item => !selectedDiv || item.Division === selectedDiv)
                    .map(item => item.District)
                    .filter(Boolean))].sort();

                const currentDist = distSelect.value;
                distSelect.innerHTML = '<option value="">সকল জেলা</option>';
                availableDistricts.forEach(d => distSelect.add(new Option(d, d)));
                if (availableDistricts.includes(currentDist)) distSelect.value = currentDist;
            }

            if (changedLevel === 'division' || changedLevel === 'district' || changedLevel === 'none') {
                const availableUpazilas = [...new Set(allData
                    .filter(item => (!selectedDiv || item.Division === selectedDiv) && (!selectedDist || item.District === selectedDist))
                    .map(item => item.Upazila)
                    .filter(Boolean))].sort();

                const currentUpa = upaSelect.value;
                upaSelect.innerHTML = '<option value="">সকল উপজেলা</option>';
                availableUpazilas.forEach(u => upaSelect.add(new Option(u, u)));
                if (availableUpazilas.includes(currentUpa)) upaSelect.value = currentUpa;
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const divVal = document.getElementById('filterDivision').value;
            const distVal = document.getElementById('filterDistrict').value;
            const upaVal = document.getElementById('filterUpazila').value;

            if(event && event.target.id === 'filterDivision') updateCascadingFilters('division');
            if(event && event.target.id === 'filterDistrict') updateCascadingFilters('district');

            filteredData = allData.filter(item => {
                const matchesSearch = (
                    (item.Institute && item.Institute.toLowerCase().includes(searchTerm)) ||
                    (item.District && item.District.toLowerCase().includes(searchTerm)) ||
                    (item.Upazila && item.Upazila.toLowerCase().includes(searchTerm))
                );
                const matchesDiv = !divVal || item.Division === divVal;
                const matchesDist = !distVal || item.District === distVal;
                const matchesUpa = !upaVal || item.Upazila === upaVal;
                return matchesSearch && matchesDiv && matchesDist && matchesUpa;
            });

            renderData(filteredData);
            
            const container = document.getElementById('dataContainer');
            const empty = document.getElementById('emptyState');
            if(filteredData.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
            } else {
                container.classList.remove('hidden');
                empty.classList.add('hidden');
            }
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterDivision').value = '';
            document.getElementById('filterDistrict').value = '';
            document.getElementById('filterUpazila').value = '';
            updateCascadingFilters('none');
            applyFilters();
        }

        document.getElementById('searchInput').addEventListener('input', applyFilters);

        // --- Render Data ---
        function renderData(data) {
            const tableBody = document.getElementById('tableBody');
            const mobileCards = document.getElementById('mobileCards');
            const totalCount = document.getElementById('totalCount');

            tableBody.innerHTML = '';
            mobileCards.innerHTML = '';
            totalCount.innerText = toBanglaDigits(data.length);

            data.forEach(item => {
                const institute = item.Institute || '';
                const upazila = item.Upazila || '';
                const district = item.District || '';
                const division = item.Division || '';
                const comment = item.Comment || '';
                const fileLinks = item.File_Links || [];

                const addressParts = [institute, upazila, district, division].filter(part => part && part.trim() !== "");
                const fullAddress = addressParts.join(', ');

                // --- Generate Image Grid HTML ---
                let imageGridHTML = '';
                if (fileLinks.length > 0) {
                    const images = fileLinks.map((link, index) => `
                        <div onclick="openModal('${link}')" 
                             class="group relative w-12 h-12 md:w-16 md:h-16 rounded-lg overflow-hidden border border-slate-200 cursor-pointer shadow-sm hover:shadow-md transition-all bg-slate-100 flex items-center justify-center">
                            <img src="${link}" 
                                 alt="ছবি" 
                                 loading="lazy"
                                 class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\\'image-off\\' class=\\'w-5 h-5 text-slate-400\\'></i>'; lucide.createIcons();">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                        </div>
                    `).join('');
                    
                    imageGridHTML = `<div class="flex flex-wrap gap-2 items-start">${images}</div>`;
                } else {
                    imageGridHTML = `<span class="text-slate-400 text-xs italic">কোনো ছবি নেই</span>`;
                }

                // --- Desktop Row ---
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors group border-b border-slate-50";
                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="flex items-start gap-2.5">
                            <div class="mt-1 bg-emerald-50 p-1.5 rounded text-emerald-600 shrink-0">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-slate-800 leading-snug mb-1">${institute || 'নাম পাওয়া যায়নি'}</h3>
                                <p class="text-xs text-slate-500">${[upazila, district, division].filter(Boolean).join(', ')}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <p class="text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100 whitespace-pre-wrap leading-relaxed">
                            ${comment ? comment : '<span class="text-slate-400 italic">কোনো মন্তব্য নেই</span>'}
                        </p>
                    </td>
                    <td class="p-4 align-top">
                        ${imageGridHTML}
                    </td>
                `;
                tableBody.appendChild(tr);

                // --- Mobile Card ---
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-4 animate-fade-in";
                
                // Images for mobile
                const mobileImages = fileLinks.length > 0 ? fileLinks.map((link) => `
                        <div onclick="openModal('${link}')" 
                             class="relative w-full pt-[100%] rounded-lg overflow-hidden border border-slate-200 cursor-pointer bg-slate-100">
                            <img src="${link}" 
                                 class="absolute inset-0 w-full h-full object-cover"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.parentElement.style.display='none';">
                        </div>
                    `).join('') : '';

                card.innerHTML = `
                    <!-- Header with Icon -->
                    <div class="flex items-start gap-3">
                        <div class="bg-emerald-100 p-2.5 rounded-lg shrink-0 text-emerald-600">
                            <i data-lucide="building-2" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm leading-snug">${institute || 'প্রতিষ্ঠান'}</h3>
                            <p class="text-xs text-slate-500 mt-0.5">${[upazila, district].filter(Boolean).join(', ')}</p>
                        </div>
                    </div>

                    <!-- Content Body -->
                    <div class="space-y-3 pl-1">
                        ${comment ? `
                        <div class="text-xs text-slate-600 bg-yellow-50/50 p-3 rounded-lg border border-yellow-100/50">
                             <span class="font-semibold text-yellow-700 block mb-1 text-[10px] uppercase">মন্তব্য</span>
                             ${comment}
                        </div>` : ''}

                        ${mobileImages ? `
                        <div>
                            <span class="font-bold text-slate-400 text-[10px] uppercase block mb-2">সংযুক্ত ছবি (${toBanglaDigits(fileLinks.length)})</span>
                            <div class="grid grid-cols-4 gap-2">
                                ${mobileImages}
                            </div>
                        </div>` : ''}
                    </div>
                `;
                mobileCards.appendChild(card);
            });

            lucide.createIcons();
        }

        function toBanglaDigits(str) {
            if (!str) return '0';
            const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            const banglaDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            return str.toString().replace(/[0-9]/g, (w) => banglaDigits[englishDigits.indexOf(w)]);
        }

        function openModal(url) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('previewImage');
            
            // Show loading state implicitly by clearing src first
            img.src = '';
            img.src = url;
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
            
            // Clear src to stop video/large image loading in background
            setTimeout(() => {
                document.getElementById('previewImage').src = '';
            }, 200);
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeModal();
            }
        });

        // Initial Load
        fetchData();
    </script>
</body>
</html>