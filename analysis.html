<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ডাটা এনালাইসিস - ১০ম গ্রেড বাস্তবায়ন পরিষদ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Html2Canvas (For Image Generation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Summary Card Style for Export */
        #exportCard {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        /* Custom Scrollbar for Table Container */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i data-lucide="pie-chart" class="w-5 h-5"></i>
                </div>
                <h1 class="font-bold text-lg text-slate-800 hidden md:block">ডাটা এনালাইসিস</h1>
                <h1 class="font-bold text-lg text-slate-800 md:hidden">এনালাইসিস</h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openExportModal()" class="hidden md:flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors shadow-sm">
                    <i data-lucide="share-2" class="w-4 h-4"></i> শেয়ার কার্ড ডাউনলোড
                </button>
                <a href="ProtestDataImages.html" class="text-sm font-medium text-slate-500 hover:text-blue-600 bg-slate-100 hover:bg-blue-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
                    <span class="hidden md:inline">মূল তালিকা</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Mobile Floating Action Button for Export -->
    <button onclick="openExportModal()" class="md:hidden fixed bottom-6 right-6 bg-emerald-600 text-white p-4 rounded-full shadow-lg z-50 hover:bg-emerald-700 transition-colors">
        <i data-lucide="share-2" class="w-6 h-6"></i>
    </button>

    <!-- Loading State -->
    <div id="loadingState" class="fixed inset-0 bg-slate-50 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
        <p class="text-slate-500 font-medium">এনালাইসিস তৈরি হচ্ছে...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="container mx-auto px-4 py-6 hidden animate-fade-in">
        
        <!-- Filter Controls -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-slate-400 uppercase flex items-center gap-2">
                    <i data-lucide="filter" class="w-4 h-4"></i> ফিল্টার অপশন
                </h3>
                <button onclick="resetAnalysisFilters()" class="text-xs font-bold text-blue-600 hover:text-blue-800 hover:underline">রিসেট</button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div>
                    <select id="anlDivision" onchange="applyAnalysisFilters()" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        <option value="">সকল বিভাগ</option>
                    </select>
                </div>
                <div>
                    <select id="anlDistrict" onchange="applyAnalysisFilters()" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        <option value="">সকল জেলা</option>
                    </select>
                </div>
                 <div>
                    <select id="anlUpazila" onchange="applyAnalysisFilters()" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        <option value="">সকল উপজেলা</option>
                    </select>
                </div>
                <div>
                    <select id="anlStatus" onchange="applyAnalysisFilters()" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        <option value="">সকল স্ট্যাটাস</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Total Institutes -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-blue-500">
                <span class="text-xs text-slate-500 font-bold uppercase block mb-1">মোট প্রতিষ্ঠান</span>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800" id="totalInstitutes">0</h3>
            </div>

            <!-- Total Districts (Contextual based on filter) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-emerald-500">
                <span class="text-xs text-slate-500 font-bold uppercase block mb-1">অংশগ্রহণকারী জেলা</span>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800" id="totalDistricts">0</h3>
            </div>

             <!-- Total Upazilas -->
             <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-orange-500">
                <span class="text-xs text-slate-500 font-bold uppercase block mb-1">অংশগ্রহণকারী উপজেলা</span>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800" id="totalUpazilas">0</h3>
            </div>
            
            <!-- Filtered Status Count (Dynamic) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-violet-500">
                 <span class="text-xs text-slate-500 font-bold uppercase block mb-1">বর্তমানে প্রদর্শিত</span>
                 <h3 class="text-2xl md:text-3xl font-bold text-slate-800" id="currentViewCount">0</h3>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- Division Bar Chart -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-slate-400"></i>
                    অংশগ্রহণ (বিভাগ/জেলা অনুযায়ী)
                </h3>
                <div class="relative h-[300px] w-full">
                    <canvas id="divisionChart"></canvas>
                </div>
            </div>

            <!-- Status Doughnut Chart -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2">
                    <i data-lucide="pie-chart" class="w-5 h-5 text-slate-400"></i>
                    স্ট্যাটাস ওভারভিউ
                </h3>
                <div class="relative h-[250px] w-full flex justify-center">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Breakdown Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 md:p-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm md:text-base">
                    <i data-lucide="list-filter" class="w-4 h-4 md:w-5 md:h-5 text-slate-400"></i>
                    বিস্তারিত পরিসংখ্যান
                </h3>
                <p class="text-xs text-slate-500 mt-1 ml-6 md:ml-7 flex flex-wrap gap-1">
                    <span class="bg-blue-100 text-blue-800 px-1.5 rounded">জেলা</span> <i data-lucide="arrow-right" class="w-3 h-3 self-center"></i>
                    <span class="bg-slate-200 text-slate-800 px-1.5 rounded">উপজেলা</span> <i data-lucide="arrow-right" class="w-3 h-3 self-center"></i>
                    <span class="bg-white border border-slate-200 px-1.5 rounded">প্রতিষ্ঠান ও ছবি</span>
                </p>
            </div>
            
            <div class="max-h-[800px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white sticky top-0 z-10 shadow-sm text-slate-600 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-3 md:p-4 border-b w-[25%]">বিভাগ</th>
                            <th class="p-3 md:p-4 border-b w-[40%]">জেলা</th>
                            <th class="hidden md:table-cell p-3 md:p-4 border-b w-[20%]">উপজেলা সংখ্যা</th>
                            <th class="p-3 md:p-4 border-b text-right w-[15%]">প্রতিষ্ঠান</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody" class="text-sm divide-y divide-slate-100 bg-white">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/95 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white bg-white/10 hover:bg-white/20 p-2 rounded-full transition-all" onclick="closeModal()">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <div class="relative max-w-5xl w-full max-h-screen flex justify-center" onclick="event.stopPropagation()">
             <img id="previewImage" src="" alt="Preview" class="max-w-full max-h-[85vh] rounded-md shadow-2xl object-contain">
        </div>
    </div>

    <!-- Export Modal & Hidden Card Container -->
    <div id="exportModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">শেয়ার কার্ড প্রিভিউ</h3>
                <button onclick="closeExportModal()" class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-4 md:p-8 flex justify-center bg-slate-100">
                <!-- The Card to Capture -->
                <div id="captureTarget" class="w-[500px] bg-white rounded-none shadow-2xl overflow-hidden relative">
                    <!-- Header -->
                    <div class="bg-blue-600 text-white p-6 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <h2 class="text-xl font-bold mb-1 relative z-10">মেডিকেল টেকনোলজিস্ট ও ফার্মাসিস্ট</h2>
                        <h3 class="text-lg font-semibold mb-1 relative z-10 text-blue-100">১০ম গ্রেড বাস্তবায়ন পরিষদ</h3>
                        <p class="text-blue-100 text-sm relative z-10 mt-2 font-medium bg-blue-700/30 inline-block px-3 py-1 rounded-full" id="cardSubtitle">কর্মবিরতি ও আন্দোলনের পরিসংখ্যান</p>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="p-6 grid grid-cols-3 gap-3">
                        <div class="bg-slate-50 p-3 rounded-lg text-center border border-slate-100">
                            <span class="text-xl font-bold text-blue-600 block" id="cardTotalInst">0</span>
                            <span class="text-[10px] text-slate-500 uppercase font-bold">প্রতিষ্ঠান</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg text-center border border-slate-100">
                            <span class="text-xl font-bold text-emerald-600 block" id="cardTotalDist">0</span>
                            <span class="text-[10px] text-slate-500 uppercase font-bold">জেলা</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg text-center border border-slate-100">
                            <span class="text-xl font-bold text-orange-600 block" id="cardTotalUpa">0</span>
                            <span class="text-[10px] text-slate-500 uppercase font-bold">উপজেলা</span>
                        </div>
                    </div>

                    <!-- Breakdown List -->
                    <div class="px-6 pb-2">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-2 flex justify-between">
                            <span>শীর্ষ অংশগ্রহণকারী এলাকা</span>
                            <span class="text-emerald-600" id="cardFilterLabel">সমগ্র দেশ</span>
                        </h4>
                        <ul id="cardTopDistricts" class="space-y-2 text-sm">
                            <!-- Items inserted by JS -->
                        </ul>
                    </div>

                    <!-- Chart Placeholder for Visual -->
                    <div class="px-6 py-4">
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden flex" id="cardProgressBar">
                            <!-- JS generates bars here -->
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                            <span>অংশগ্রহণ অনুপাত</span>
                            <span id="cardStatusText">আপডেট চলছে</span>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
                        <p class="text-[10px] text-slate-400 font-medium">তথ্যসূত্র: ইন্টারনাল ডাটাবেস • রিপোর্ট: <span id="cardDate"></span></p>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeExportModal()" class="px-4 py-2 text-slate-600 font-bold text-sm hover:bg-slate-100 rounded-lg">বাতিল</button>
                <button onclick="downloadImage()" class="px-6 py-2 bg-blue-600 text-white font-bold text-sm rounded-lg hover:bg-blue-700 shadow-md flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> ডাউনলোড ইমেজ
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center py-8">
        <p class="text-slate-400 text-xs">© ২০২৫ ১০ম গ্রেড বাস্তবায়ন পরিষদ</p>
    </div>

    <script>
        lucide.createIcons();

        // --- API & GLOBALS ---
        const API_KEY = 'AIzaSyDTvwDm19m-xtkMuALsspEJB-NNYV0kdUg'; 
        const SHEET_ID = '1lAgWuhQpBJE-NyrdnNiRxkbS5NdaB6zwOwb2agJAwRc';
        const SHEET_NAME = 'File-Received';
        const DATA_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;

        let rawData = [];
        let filteredData = [];
        let divisionChart = null;
        let statusChart = null;

        // Register Chart DataLabels
        Chart.register(ChartDataLabels);

        // Helper: Convert Google Drive Links to Direct Image Links
        function getDirectImageLink(url) {
            if (!url) return null;
            url = url.trim();

            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                let id = null;
                let parts = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (parts && parts[1]) {
                    id = parts[1];
                } else {
                    parts = url.match(/id=([a-zA-Z0-9_-]+)/);
                    if (parts && parts[1]) {
                        id = parts[1];
                    }
                }
                if (id) {
                    return `https://lh3.googleusercontent.com/d/${id}`;
                }
            }
            return url;
        }

        // --- FETCH DATA ---
        async function initAnalysis() {
            try {
                const response = await fetch(DATA_URL);
                const result = await response.json();
                
                if (result.values && result.values.length > 0) {
                    const rows = result.values.slice(1);
                    rawData = rows.map(row => {
                        // Link parsing logic
                        let extractedLinks = [];
                        const rawCells = row.slice(12) || [];
                        rawCells.forEach(cell => {
                            if (cell && typeof cell === 'string') {
                                const potentials = cell.split(/[\s,]+/).filter(u => u.startsWith('http'));
                                extractedLinks.push(...potentials);
                            }
                        });
                        const validLinks = extractedLinks.map(link => getDirectImageLink(link)).filter(link => link !== null);

                        return {
                            division: row[6]?.trim() || "অজানা",
                            district: row[7]?.trim() || "অজানা",
                            upazila: row[8]?.trim() || "অজানা",
                            institute: row[9]?.trim() || "",
                            status: row[10]?.trim() || "No Status",
                            comment: row[11]?.trim() || "",
                            fileLinks: validLinks 
                        };
                    }).filter(item => item.district !== "অজানা");
                    
                    filteredData = [...rawData];
                    populateAnalysisFilters();
                    updateDashboard();
                }
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('loadingState').innerHTML = `<p class="text-red-500">ডাটা লোড সমস্যা হয়েছে</p>`;
            }
        }

        // --- FILTER LOGIC ---
        function populateAnalysisFilters() {
            const divSelect = document.getElementById('anlDivision');
            const statSelect = document.getElementById('anlStatus');

            const divisions = [...new Set(rawData.map(d => d.division))].sort();
            const statuses = [...new Set(rawData.map(d => d.status))].filter(Boolean).sort();

            divSelect.innerHTML = '<option value="">সকল বিভাগ</option>';
            divisions.forEach(d => divSelect.add(new Option(d, d)));

            statSelect.innerHTML = '<option value="">সকল স্ট্যাটাস</option>';
            statuses.forEach(s => statSelect.add(new Option(s, s)));

            updateAnalysisCascadingFilters();
        }

        function updateAnalysisCascadingFilters() {
            const divVal = document.getElementById('anlDivision').value;
            const distSelect = document.getElementById('anlDistrict');
            const upaSelect = document.getElementById('anlUpazila');

            const availableDistricts = [...new Set(rawData
                .filter(d => !divVal || d.division === divVal)
                .map(d => d.district))].sort();

            const currentDist = distSelect.value;
            distSelect.innerHTML = '<option value="">সকল জেলা</option>';
            availableDistricts.forEach(d => distSelect.add(new Option(d, d)));
            if(availableDistricts.includes(currentDist)) distSelect.value = currentDist;

             const distVal = distSelect.value;
             const availableUpazilas = [...new Set(rawData
                .filter(d => (!divVal || d.division === divVal) && (!distVal || d.district === distVal))
                .map(d => d.upazila))].sort();
            
            const currentUpa = upaSelect.value;
            upaSelect.innerHTML = '<option value="">সকল উপজেলা</option>';
            availableUpazilas.forEach(u => upaSelect.add(new Option(u, u)));
             if(availableUpazilas.includes(currentUpa)) upaSelect.value = currentUpa;
        }

        function applyAnalysisFilters() {
            const divVal = document.getElementById('anlDivision').value;
            const distVal = document.getElementById('anlDistrict').value;
            const upaVal = document.getElementById('anlUpazila').value;
            const statVal = document.getElementById('anlStatus').value;

            if(event && (event.target.id === 'anlDivision' || event.target.id === 'anlDistrict')) {
                updateAnalysisCascadingFilters();
            }

            filteredData = rawData.filter(item => {
                return (!divVal || item.division === divVal) &&
                       (!distVal || item.district === distVal) &&
                       (!upaVal || item.upazila === upaVal) &&
                       (!statVal || item.status === statVal);
            });

            updateDashboard();
        }

        function resetAnalysisFilters() {
            document.getElementById('anlDivision').value = '';
            document.getElementById('anlDistrict').value = '';
            document.getElementById('anlUpazila').value = '';
            document.getElementById('anlStatus').value = '';
            updateAnalysisCascadingFilters();
            filteredData = [...rawData];
            updateDashboard();
        }

        // --- DASHBOARD UPDATE ---
        function updateDashboard() {
            const totalCount = filteredData.length;
            const uniqueDivs = [...new Set(filteredData.map(d => d.division))].length;
            const uniqueDists = [...new Set(filteredData.map(d => d.district))].length;
            const uniqueUpas = [...new Set(filteredData.map(d => d.upazila))].length;

            document.getElementById('totalInstitutes').innerText = toBanglaDigits(rawData.length);
            document.getElementById('totalDistricts').innerText = toBanglaDigits(uniqueDists);
            document.getElementById('totalUpazilas').innerText = toBanglaDigits(uniqueUpas);
            document.getElementById('currentViewCount').innerText = toBanglaDigits(totalCount);

            const divisionCounts = {};
            const statusCounts = {};
            
            const isDistrictLevel = document.getElementById('anlDivision').value !== "";
            const chartLabel = isDistrictLevel ? "জেলা অনুযায়ী" : "বিভাগ অনুযায়ী";
            
            filteredData.forEach(item => {
                const key = isDistrictLevel ? item.district : item.division;
                divisionCounts[key] = (divisionCounts[key] || 0) + 1;

                const s = item.status === "No Status" ? "স্ট্যাটাস নেই" : item.status;
                statusCounts[s] = (statusCounts[s] || 0) + 1;
            });

            renderCharts(divisionCounts, statusCounts, chartLabel);
            renderDetailedTable();
        }

        function renderCharts(mainCounts, statCounts, mainLabel) {
            if(divisionChart) divisionChart.destroy();
            if(statusChart) statusChart.destroy();

            const divCtx = document.getElementById('divisionChart').getContext('2d');
            divisionChart = new Chart(divCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(mainCounts),
                    datasets: [{
                        label: 'প্রতিষ্ঠান সংখ্যা',
                        data: Object.values(mainCounts),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        barThickness: 'flex',
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 25 // Avoid label cut off
                        }
                    },
                    plugins: { 
                        legend: { display: false },
                        datalabels: { // Data Labels Configuration
                            anchor: 'end',
                            align: 'top',
                            color: '#64748b',
                            font: {
                                weight: 'bold',
                                family: "'Hind Siliguri', sans-serif"
                            },
                            formatter: (value) => toBanglaDigits(value)
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                },
                plugins: [ChartDataLabels]
            });

            const statCtx = document.getElementById('statusChart').getContext('2d');
            const statColors = ['#10b981', '#f59e0b', '#ef4444', '#6366f1', '#94a3b8'];
            
            statusChart = new Chart(statCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statCounts),
                    datasets: [{
                        data: Object.values(statCounts),
                        backgroundColor: statColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { position: 'right', labels: { font: { family: "'Hind Siliguri', sans-serif" }, boxWidth: 12 } },
                        datalabels: { display: false } // Disable labels for doughnut to stay clean
                    }
                }
            });
        }

        // --- DETAILED TABLE WITH 3-LEVEL ACCORDION ---
        function renderDetailedTable() {
            const tbody = document.getElementById('analysisTableBody');
            
            // 1. Process Data Group by District -> Upazila -> Records
            const districtStats = {}; 

            filteredData.forEach(item => {
                const key = `${item.division}|${item.district}`;
                if (!districtStats[key]) {
                    districtStats[key] = { total: 0, division: item.division, district: item.district, upazilas: {} };
                }
                
                districtStats[key].total++;
                
                const upa = item.upazila || "অজানা";
                if (!districtStats[key].upazilas[upa]) {
                    districtStats[key].upazilas[upa] = [];
                }
                districtStats[key].upazilas[upa].push(item);
            });

            // 2. Sort Districts by Total Count
            const sortedDistricts = Object.values(districtStats).sort((a, b) => b.total - a.total);

            // 3. Generate HTML
            tbody.innerHTML = sortedDistricts.map((item, dIndex) => {
                const rowId = `row-${dIndex}`;
                
                // Sort Upazilas inside district
                const sortedUpazilas = Object.entries(item.upazilas)
                    .sort((a, b) => b[1].length - a[1].length);

                // Generate Upazila List HTML (Nested Accordion)
                const upazilaListHTML = sortedUpazilas.map(([upaName, records], uIndex) => {
                    const upaId = `upa-${dIndex}-${uIndex}`;
                    
                    // Generate Institute List HTML (Level 3 Accordion)
                    const instituteListHTML = records.map((rec, iIndex) => {
                        const instId = `inst-${dIndex}-${uIndex}-${iIndex}`;
                        const hasImages = rec.fileLinks && rec.fileLinks.length > 0;
                        const hasContent = hasImages || rec.comment;
                        
                        // Image Grid
                        const imagesHTML = hasImages ? rec.fileLinks.map(link => `
                            <div onclick="openModal('${link}')" class="w-16 h-16 border border-slate-200 rounded-lg overflow-hidden cursor-pointer hover:shadow-md transition-all group/img relative">
                                <img src="${link}" class="w-full h-full object-cover transition-transform group-hover/img:scale-110" loading="lazy">
                                <div class="absolute inset-0 bg-black/0 group-hover/img:bg-black/10 transition-colors"></div>
                            </div>
                        `).join('') : '<span class="text-xs text-slate-400 italic">কোনো ছবি নেই</span>';

                        return `
                            <div class="border-b border-slate-100 last:border-0 bg-white">
                                <!-- Institute Header (Clickable if content exists) -->
                                <div onclick="${hasContent ? `toggleDetails('${instId}')` : ''}" class="flex items-start gap-2 p-3 ${hasContent ? 'cursor-pointer hover:bg-slate-50' : ''} transition-colors group/inst">
                                     <i id="icon-${instId}" data-lucide="${hasContent ? 'chevron-right' : 'minus'}" class="w-4 h-4 text-slate-300 mt-0.5 shrink-0 transition-transform ${hasContent ? '' : 'invisible'}"></i>
                                     <div class="flex-grow">
                                        <div class="text-sm font-semibold text-slate-700 group-hover/inst:text-blue-600 transition-colors leading-tight">${rec.institute || "প্রতিষ্ঠান নাম নেই"}</div>
                                        <div class="flex flex-wrap gap-2 mt-1.5">
                                            ${rec.status ? `<span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100 font-bold">${rec.status}</span>` : ''}
                                            ${hasImages ? `<span class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded border border-emerald-100 flex items-center gap-1"><i data-lucide="image" class="w-3 h-3"></i> ${toBanglaDigits(rec.fileLinks.length)} ছবি</span>` : ''}
                                        </div>
                                     </div>
                                </div>
                                
                                <!-- Institute Details (Images & Comment) -->
                                <div id="${instId}" class="hidden pl-9 pr-3 pb-3">
                                    ${rec.comment ? `
                                        <div class="text-xs text-slate-600 mb-2 italic bg-slate-50 p-2.5 rounded-lg border border-slate-100 flex gap-2">
                                            <i data-lucide="message-square" class="w-3 h-3 text-slate-400 mt-0.5 shrink-0"></i>
                                            <span>"${rec.comment}"</span>
                                        </div>` : ''}
                                    
                                    ${hasImages ? `
                                        <div class="flex flex-wrap gap-2 mt-2">
                                            ${imagesHTML}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="border border-slate-200 rounded-lg mb-2 bg-white overflow-hidden shadow-sm">
                            <!-- Upazila Header (Clickable) -->
                            <div onclick="toggleDetails('${upaId}')" class="flex justify-between items-center p-3 cursor-pointer hover:bg-slate-50 transition-colors border-b border-transparent hover:border-slate-100">
                                <span class="text-sm text-slate-700 font-bold flex items-center gap-2">
                                    <i id="icon-${upaId}" data-lucide="chevron-right" class="w-4 h-4 text-slate-300 transition-transform duration-200"></i>
                                    ${upaName}
                                </span>
                                <span class="text-xs font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded-full border border-slate-200">${toBanglaDigits(records.length)}</span>
                            </div>
                            
                            <!-- Upazila Details (Hidden Institutes List) -->
                            <div id="${upaId}" class="hidden border-t border-slate-100 bg-slate-50/30">
                                ${instituteListHTML}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <!-- Main District Row -->
                    <tr onclick="toggleDetails('${rowId}')" class="cursor-pointer hover:bg-slate-50 transition-colors border-b border-slate-50 group select-none">
                        <td class="p-3 md:p-4 text-slate-500 text-xs md:text-sm group-hover:text-blue-600 font-medium align-middle">${item.division}</td>
                        <td class="p-3 md:p-4 font-bold text-slate-800 text-sm align-middle">
                             <div class="flex items-center gap-2">
                                <i id="icon-${rowId}" data-lucide="chevron-right" class="w-4 h-4 text-slate-300 transition-transform duration-200 group-hover:text-blue-500"></i>
                                ${item.district}
                             </div>
                        </td>
                        <td class="hidden md:table-cell p-3 md:p-4 text-slate-400 text-xs align-middle">
                            ${toBanglaDigits(sortedUpazilas.length)} টি উপজেলা
                        </td>
                        <td class="p-3 md:p-4 text-right align-middle">
                            <span class="inline-block bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-100 group-hover:bg-blue-600 group-hover:text-white group-hover:border-blue-600 transition-all">
                                ${toBanglaDigits(item.total)}
                            </span>
                        </td>
                    </tr>
                    
                    <!-- District Detail Row (Hidden) -->
                    <tr id="${rowId}" class="hidden bg-slate-50/20">
                        <td colspan="4" class="p-0 border-b border-slate-100">
                            <div class="p-3 md:p-4 pl-4 md:pl-10">
                                <div class="mb-3 text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                    <i data-lucide="corner-down-right" class="w-4 h-4"></i>
                                    ${item.district}-এর বিস্তারিত তালিকা
                                </div>
                                <div class="flex flex-col gap-1">
                                    ${upazilaListHTML}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        // Toggle function for Accordion
        function toggleDetails(id) {
            // Stop propagation if clicked inside nested elements to avoid bubbling issues
            if (event && event.stopPropagation) event.stopPropagation();

            const row = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                if(icon) icon.style.transform = "rotate(90deg)";
            } else {
                row.classList.add('hidden');
                if(icon) icon.style.transform = "rotate(0deg)";
            }
        }

        // --- IMAGE EXPORT LOGIC ---
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            
            // 1. Determine Dynamic Context Title
            const divFilter = document.getElementById('anlDivision').value;
            const distFilter = document.getElementById('anlDistrict').value;
            const upaFilter = document.getElementById('anlUpazila').value;
            
            let contextTitle = "সমগ্র বাংলাদেশ";
            if (divFilter) contextTitle = `${divFilter} বিভাগ`;
            if (distFilter) contextTitle = `${distFilter} জেলা, ${divFilter}`;
            if (upaFilter) contextTitle = `${upaFilter}, ${distFilter}`;

            document.getElementById('cardSubtitle').innerText = `${contextTitle} - পরিসংখ্যান`;
            document.getElementById('cardFilterLabel').innerText = divFilter || "সমগ্র দেশ";

            // 2. Set Stats based on FILTERED Data
            document.getElementById('cardTotalInst').innerText = toBanglaDigits(filteredData.length);
            document.getElementById('cardTotalDist').innerText = toBanglaDigits([...new Set(filteredData.map(d=>d.district))].length);
            document.getElementById('cardTotalUpa').innerText = toBanglaDigits([...new Set(filteredData.map(d=>d.upazila))].length);
            
            // 3. Dynamic Breakdown (District or Upazila based on level)
            const listContainer = document.getElementById('cardTopDistricts');
            let breakdownMap = {};
            
            // If viewing specific District -> Show Top Upazilas
            if (distFilter) {
                document.getElementById('cardFilterLabel').innerText = "অংশগ্রহণকারী উপজেলা";
                filteredData.forEach(d => { breakdownMap[d.upazila] = (breakdownMap[d.upazila] || 0) + 1; });
            } else {
                // Else Show Top Districts
                document.getElementById('cardFilterLabel').innerText = divFilter ? "শীর্ষ জেলা" : "শীর্ষ জেলাসমূহ";
                filteredData.forEach(d => { breakdownMap[d.district] = (breakdownMap[d.district] || 0) + 1; });
            }

            const topItems = Object.entries(breakdownMap)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 5); // Top 5
            
            const listHtml = topItems.map((d, i) => `
                <li class="flex justify-between items-center bg-slate-50 p-2 rounded border-b border-slate-100">
                    <span class="font-semibold text-slate-700"><span class="text-blue-400 mr-2">#${toBanglaDigits(i+1)}</span> ${d[0]}</span>
                    <span class="font-bold text-slate-800">${toBanglaDigits(d[1])}</span>
                </li>
            `).join('');
            listContainer.innerHTML = listHtml || '<li class="text-center text-slate-400 text-xs py-2">তথ্য নেই</li>';

            // 4. Progress Visual
            const barColors = ['bg-blue-500', 'bg-emerald-500', 'bg-violet-500', 'bg-orange-500', 'bg-slate-300'];
            const total = filteredData.length;
            const barHtml = topItems.map((d, i) => {
                const width = total > 0 ? (d[1] / total) * 100 : 0;
                return `<div style="width: ${width}%" class="${barColors[i] || 'bg-slate-400'} h-full"></div>`;
            }).join('');
            document.getElementById('cardProgressBar').innerHTML = barHtml + `<div class="bg-slate-100 flex-grow h-full"></div>`;

            // Date & Time
            const today = new Date();
            const dateStr = today.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = today.toLocaleTimeString('bn-BD', { hour: 'numeric', minute: 'numeric', hour12: true });

            document.getElementById('cardDate').innerText = `${dateStr} • ${timeStr}`;
            document.getElementById('cardStatusText').innerText = "আপডেট: " + dateStr;

            modal.classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function downloadImage() {
            const element = document.getElementById('captureTarget');
            
            html2canvas(element, { 
                scale: 2, 
                backgroundColor: "#ffffff",
                logging: false 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Status-Card-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // Image Preview Modal Helpers
        function openModal(url) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('previewImage');
            
            // Simple loading effect
            img.src = '';
            img.src = url;
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            
            setTimeout(() => {
                document.getElementById('previewImage').src = '';
            }, 200);
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeModal();
                closeExportModal();
            }
        });

        function toBanglaDigits(str) {
            if (!str) return '0';
            const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            const banglaDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            return str.toString().replace(/[0-9]/g, (w) => banglaDigits[englishDigits.indexOf(w)]);
        }

        initAnalysis();
    </script>
</body>
</html>


